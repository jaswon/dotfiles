#!/bin/sh

# font='Gohu GohuFont:pixelsize=16:0'
font='Misc Tamsyn:pixelsize=14:0'
act='onstart=uncollapse,grabkeys;button1=exit:0;key_Escape=exit:0;onexit=exec:pkill tail'
hl='#f00'
x=1694
y=30
w=226
h=36

calfifo=/tmp/calfifo

if [[ ! -e $calfifo ]]; then
  mkfifo $calfifo
  ( tail -f "$calfifo" | dzen2 -l 8 -fn "$font" -fg "#fff" -bg "#333" -w $w -h $h -y $y -x $x -ta c -sa c -e "$act" -u -title-name "popup-calendar" -p
  rm -f "$calfifo") &
fi

curday=$(date '+%_d')
curmonth=$(date '+%m')
curyear=$(date '+%Y')

selmonth=${1:-"$curmonth"}
selyear=${2:-"$curyear"}
nextmonth=$((selmonth+1))
prevmonth=$((selmonth-1))
let nextyear=prevyear=selyear

if [[ $nextmonth -eq 13 ]]; then
  nextmonth=1
  nextyear=$((selyear+1))
fi

if [[ $prevmonth -eq 0 ]]; then
  prevmonth=12
  prevyear=$((selyear-1))
fi

if [[ "$selmonth" -eq "$curmonth" ]] && [[ "$selyear" -eq "$curyear" ]]; then
  cal=$(cal | sed -r "s/^([ 0-9 ]{3}*)$curday /\1^fg($hl)$curday^fg() /")
else
  cal=$(cal $selmonth $selyear)
fi

IFS=$'\n' read -rd '' calhead calbody <<< "$cal"

(
  echo $calhead 
  echo "^ca(1, $0 $prevmonth $prevyear)<<< Prev^ca()    ^ca(1, $0 $nextmonth $nextyear)Next >>>^ca()" 
  echo "$calbody" 
) > $calfifo
